<!DOCTYPE html>
<html>
<head>
  <title>Creature Viewer</title>
  <style>
    canvas {
      image-rendering: pixelated;
      background: #333333;
      display: block;
      margin: 0 auto;
    }
    body {
      text-align: center;
      color: white;
      font-family: sans-serif;
      background: #222;
    }
  </style>
</head>
<body>
  <canvas id="world" width="500" height="500"></canvas>

  <script type="text/javascript">
    let CREATURES = [];
    let FOOD = [];
    let SPRITES = {};

    const canvas = document.getElementById("world");
    const ctx = canvas.getContext("2d");

    function drawFrame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw food
      ctx.fillStyle = "green";
      for (const [x, y] of FOOD) {
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
      }

      // Draw creatures
      for (const c of CREATURES) {
        const angle = c.direction;
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);

        const layout = SPRITES[c.sprite_id];
        if (!layout) continue;

        const organs = layout.split("|").filter(Boolean).map(line => {
          const [type, x, y, size] = line.split(",");
          return {
            type,
            x: parseFloat(x),
            y: parseFloat(y),
            size: parseFloat(size),
          };
        });

        const body = organs.find(o => o.type === "body") || { x: 0, y: 0 };
        const body_rx = body.x * cos - body.y * sin;
        const body_ry = body.x * sin + body.y * cos;
        const cx = c.position[0] + body_rx;
        const cy = c.position[1] + body_ry;

        for (const organ of organs) {
          if (organ.type === "body") continue;

          const rx = organ.x * cos - organ.y * sin;
          const ry = organ.x * sin + organ.y * cos;
          const ox = c.position[0] + rx;
          const oy = c.position[1] + ry;

          // Color by organ type
          switch (organ.type) {
            case "spike": ctx.fillStyle = "red"; break;
            case "mouth": ctx.fillStyle = "yellow"; break;
            case "eye": ctx.fillStyle = "white"; break;
            case "flipper": ctx.fillStyle = "orange"; break;
            default: ctx.fillStyle = "#ccc"; break;
          }

          // Line from body to organ
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.lineTo(ox, oy);
          ctx.stroke();

          ctx.beginPath();
          ctx.arc(ox, oy, organ.size * 0.5, 0, 2 * Math.PI);
          ctx.fill();
        }

        // Draw body
        ctx.fillStyle = "blue";
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, 2 * Math.PI);
        ctx.fill();
      }

    }

    // 🔁 Fetch loop (async, every 200ms)
    async function fetchLoop() {
      while (true) {
        try {
          const res = await fetch("/evolvit/viewer/data");

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          CREATURES = data.creatures;
          FOOD = data.food;
          SPRITES = data.sprites;
        } catch (err) {
          console.error("Fetch error:", err);
        }
        await new Promise(r => setTimeout(r, 1000)); // 5 FPS
      }
    }

    // 🎥 Draw loop (aim for 60 FPS, browser controlled)
    function drawLoop() {
      drawFrame();
      requestAnimationFrame(drawLoop);
    }

    // 🚀 Start loops
    fetchLoop();
    requestAnimationFrame(drawLoop);
  </script>
</body>
</html>